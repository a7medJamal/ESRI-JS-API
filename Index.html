<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://js.arcgis.com/4.4"></script>
    <link rel="styleSheet" href="https://js.arcgis.com/4.4/esri/css/main.css">
    <title>esri api tutorial</title>
</head>

<body>
    <span style="color:red; font-size:20px"> Services:</span> <select id="lstServices"></select>
    <span style="color:red; font-size:20px"> Basemap:</span> <select id="buttons"></select>
    <table border="1">
        <tr>
            <td valign=top>
                <div id="toc">

                </div>
            </td>

            <td>
                <div id="mapView" style="width:1000px;height:500px">Map Goes here</div>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <div id="Pages"> Pages:</div>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <div id="attributeTable">Atribute Table: </div>
            </td>
        </tr>
    </table>



    <script>
        let mapview;
        let map;
        let layer;
        let Request;
        let selectdService;
        const DefaultBaseMap = "streets";
        const DefaultService = "Water_Network";
        const DefaultPageSize = "100";

        require(['esri/Map',
            'esri/views/MapView',
            'esri/request',
            'esri/layers/MapImageLayer',
            'esri/widgets/Legend',
            'esri/widgets/Search'],
            function (Map,
                MapView,
                EsriRequest,
                MapLayer,
                Legend,
                Search) {

                Request = EsriRequest;

                generateBaseMaps();

                map = new Map({ basemap: DefaultBaseMap });

                var viewOptions = {
                    container: "mapView", map: map, zoom: 15,
                    center: [-88.15305218650816, 41.77040974261415]

                };

                mapview = new MapView(viewOptions);

                // this only to add legend widget
                let legend = new Legend({ view: mapview });
                mapview.ui.add(legend, "bottom-left");

                //this only for add Search widget
                let search = new Search({ view: mapview });
                mapview.ui.add(search, "top-right");

                //query the sample server and list all map services in a dropdownlist
                populateMapServices();


                //populate the drop downlist of map services
                function populateMapServices() {

                    //this to get all services in arcserver API
                    let Url = 'https://sampleserver6.arcgisonline.com/arcgis/rest/services?f=pjson';
                    let options = { responseType: "json" };
                    Request(Url, options).then(response => {
                        let result = response.data;
                        let lstServices = document.getElementById("lstServices");

                        //set event listener onChange
                        lstServices.addEventListener("change", onChangeServiceMap);
                        // this to add all services from url to selectbox
                        for (var i = 0; i < result.services.length; i++) {
                            let option = document.createElement("option");
                            option.textContent = result.services[i].name;
                            if (DefaultService == result.services[i].name) option.selected = true;
                            lstServices.appendChild(option);
                            // alert(result.services[i].name)
                        }
                        onChangeServiceMap();
                    });
                }
                //on change service Map
                function onChangeServiceMap() {

                    selectdService = lstServices
                        .options[lstServices.selectedIndex].textContent;

                    //add a layer
                    layer = new MapLayer({ url: "https://sampleserver6.arcgisonline.com/arcgis/rest/services/" + selectdService + "/MapServer" });
                    map.removeAll();
                    map.add(layer);
                    //wait until the layer is loaded
                    layer.then(buildToc)

                }

            })

        function buildToc() {
            //this code to generate table of content (visible & not visible)
            let toc = document.getElementById("toc");
            toc.innerHTML = "";

            let layerList = document.createElement("ul");
            toc.appendChild(layerList);

            //populate layer in list
            populateLayerRecursive(layer, layerList);

            mapview.goTo(layer.fullExtent)

        }
        //this for query data
        function getCount(layerId, featureCount) {
            let queryUrl = "https://sampleserver6.arcgisonline.com/arcgis/rest/services/"
                + selectdService + "/MapServer/" + layerId + "/query";
            let queryOption = {
                responseType: "json",
                query: {
                    f: "json",
                    where: "1=1",
                    returnCountOnly: true
                }
            }

            Request(queryUrl, queryOption).then(
                response => featureCount(response.data.count),
                response => featureCount(0));
        }

        // populate layer Recursive in the input element
        function populateLayerRecursive(thislayer, layerList) {

            let chk = document.createElement("input");
            chk.type = "checkbox";
            chk.value = thislayer.id;
            chk.checked = thislayer.visible;

            chk.addEventListener("click", e => { thislayer.visible = e.target.checked })

            let lbl = document.createElement("label");
            lbl.textContent = thislayer.title + "   ";

            let btn = document.createElement("button");
            btn.textContent = "view";

            //this method to get count for every layer
            //getCount(thislayer.id, btn);
            //on click, open attribut table
            btn.layerId = thislayer.id;
            btn.addEventListener("click", openAttributeTable);

            let layerItem = document.createElement("li");
            layerItem.appendChild(chk);
            layerItem.appendChild(lbl);
            layerList.appendChild(layerItem);
            layerItem.appendChild(btn);
            if (thislayer.sublayers != null && thislayer.sublayers.items.length > 0) {

                let newList = document.createElement("ul");
                layerList.appendChild(newList);

                for (let i = 0; i < thislayer.sublayers.length; i++) {

                    populateLayerRecursive(thislayer.sublayers.items[i], newList)
                }
            }
        }

        //generate alots of button of basemaps
        function generateBaseMaps() {
            let basemaps = [];
            //  <!-- Unable to find basemap definition for: test. Try one of these:
            //   "streets", "satellite", "hybrid", "terrain", "topo", "gray", "dark-gray", "oceans", 
            //   "national-geographic", "osm", "dark-gray-vector", "gray-vector", "streets-vector", 
            //   "topo-vector", "streets-night-vector", "streets-relief-vector", "streets-navigation-vector" -->
            basemaps.push("satellite");
            basemaps.push("hybrid");
            basemaps.push("topo");
            basemaps.push("oceans");
            basemaps.push("terrain");
            basemaps.push("streets");
            basemaps.push("osm");
            basemaps.push("topo-vector");
            basemaps.push("national-geographic");
            basemaps.push("streets-night-vector");

            //generate multi basemap on the fly
            let setBaseMap = e => {
                let list = e.target;
                let selectedBasemap = list.options[list.selectedIndex].textContent;
                map.basemap = selectedBasemap;
            };
            let cmbBasemaps = document.getElementById("buttons");
            cmbBasemaps.addEventListener("change", setBaseMap)

            for (let i = 0; i < basemaps.length; i++) {


                let option = document.createElement("option");
                option.id = basemaps[i];
                option.textContent = basemaps[i];

                if (basemaps[i] == DefaultBaseMap) option.selected = true;

                cmbBasemaps.appendChild(option);
            }
        }

        let buttonPages = [];
        function restPages() {
        buttonPages.forEach(b=> {
            b.style.color = "black";
        })
        }

        //to paging all recordes
        function populatePages(layerId, featureCount) {
            let pageCount = Math.ceil(featureCount / DefaultPageSize);
            let pagesDiv = document.getElementById("Pages");
            pagesDiv.innerHTML = "";

            for (let i = 0; i < pageCount; i++) {
                let page = document.createElement("button");
                page.textContent = i + 1;
                buttonPages.push(page);
                page.addEventListener("click", function (e) {
                    restPages();
                    e.target.style.color = "red";
                    populateAtributeTable(layerId, i + 1, featureCount);
                })
                pagesDiv.appendChild(page);
            }
            // alert("page count : " + pageCount);
        }

        function openAttributeTable(e) {
            let layerId = e.target.layerId;
            let featureCount = 0;
            getCount(layerId, c => {
                featureCount = c;
                populatePages(layerId, featureCount);
                populateAtributeTable(layerId, 1, featureCount)
            })
        }

        //populate the attribute of a given layer
        function populateAtributeTable(layerId, page, featureCount) {
            //alert("Calling attribute table "+ e.target.layerId);

            //  alert(featureCount);

            let attributeTable = document.getElementById("attributeTable");
            attributeTable.innerHTML = "";
            let queryUrl = "https://sampleserver6.arcgisonline.com/arcgis/rest/services/"
                + selectdService + "/MapServer/" + layerId + "/query";
            let queryOption = {
                responseType: "json",
                query: {
                    f: "json",
                    where: "1=1",
                    returnCountOnly: false,
                    outFields: "*",
                    resultOffset: (page - 1) * DefaultPageSize + 1,
                    resultRecordCount: DefaultPageSize
                }
            }

            Request(queryUrl, queryOption).then(response => {

                //alert(response.data.fields.length);
                let table = document.createElement("table");
                table.border = 2;
                let header = document.createElement("tr");
                table.appendChild(header);
                //populate the fileds / columns
                for (let i = 0; i < response.data.fields.length; i++) {

                    let column = document.createElement("th");
                    column.textContent = response.data.fields[i].alias;
                    header.appendChild(column);
                }

                //loop through all features
                for (let j = 0; j < response.data.features.length; j++) {
                    let feature = response.data.features[j];
                    let row = document.createElement("tr");
                    table.appendChild(row);
                    for (let i = 0; i < response.data.fields.length; i++) {

                        let field = response.data.fields[i];

                        let column = document.createElement("td");

                        // this to convert datetime from EPOCH(this to use samply to use by any thing in programming
                        //  (samply to convert to mile second)) to Date
                        if (field.type == "esriFieldTypeDate") {

                            let date = new Date(feature.attributes[field.name]);
                            column.textContent = date.toLocaleDateString('en-US');;
                        }
                        else {
                            column.textContent = feature.attributes[field.name];

                        }
                        row.appendChild(column);
                    }
                }


                attributeTable.appendChild(table);

            }, response => el.style.visibility = "hidden");
        }
    </script>
</body>

</html>


<!-- 
<< Code in Console window in  google chrome >>

    if you need to check how many layer in ever layer and another important sample code
layer.sublayers.length
2
layer.sublayers.items[0].sublayers.lenght
1
map.layers.items[0].sublayers._items[0].title
"Damage to Residential Buildings"
map.layers.items[0].sublayers.length
1
map.layers.items[0].findSublayerById(0).title
"No Permit"
map.layers.items[0].findSublayerById(0).visible=false
false
map.layers.items[0].findSublayerById(0).visible=true
true


layer.sublayers.items.length
1
layer.sublayers.items[0].sublayers._items.length
3
layer.sublayers.items[0].sublayers._items[0].sublayers._items.length
2
layer.sublayers.items[0].sublayers._items[0].id
7
-->